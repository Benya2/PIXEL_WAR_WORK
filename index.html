<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel War</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <h1>Pixel war</h1>

    <div id="cursor"></div>
    <canvas id="game"></canvas>
    <div id="colorsChoice"></div>

    <!-- Подключаем Firebase через CDN для использования модульного синтаксиса -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBUPWN3TveghkTWByX1vjN4ZSQsi-1At1Q",
            authDomain: "pixel-war-d1f8f.firebaseapp.com",
            projectId: "pixel-war-d1f8f",
            storageBucket: "pixel-war-d1f8f.firebasestorage.app",
            messagingSenderId: "484452565594",
            appId: "1:484452565594:web:5f820d6551c6c87956ce63"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        console.log("Firebase Firestore подключен!");

        const colorsChoice = document.querySelector('#colorsChoice');
        const game = document.querySelector('#game');
        const cursor = document.querySelector('#cursor');
        
        game.width = 1200;
        game.height = 600;
        const gridCellSize = 10;
        
        const ctx = game.getContext('2d');
        const gridCtx = game.getContext('2d');
        
        const colorList = [
            "#FFEBEE", "#FCE4EC", "#F3E5F5", "#B39DDB", "#9FA8DA", "#90CAF9", "#81D4FA", "#80DEEA",
            "#4DB6AC", "#66BB6A", "#9CCC65", "#CDDC39", "#FFEB3B", "#FFC107", "#FF9800", "#FF5722",
            "#A1887F", "#E0E0E0", "#90A4AE", "#000"
        ];
        let currentColorChoice = colorList[9];

        // Инициализация палитры цветов
        colorList.forEach(color => {
            const colorItem = document.createElement('div');
            colorItem.style.backgroundColor = color;
            colorsChoice.appendChild(colorItem);

            colorItem.addEventListener('click', () => {
                currentColorChoice = color;

                colorItem.innerHTML = `<i class="fa-solid fa-check"></i>`;

                setTimeout(() => {
                    colorItem.innerHTML = "";
                }, 1000);
            });
        });

        // Функция для рисования пикселя
        function createPixel(x, y, color) {
            ctx.beginPath();
            ctx.fillStyle = color;
            ctx.fillRect(x, y, gridCellSize, gridCellSize);
        }

        // Функция добавления пикселя в базу данных Firestore
        function addPixelIntoGame() {
            const x = cursor.offsetLeft;
            const y = cursor.offsetTop - game.offsetTop;

            createPixel(x, y, currentColorChoice);

            const pixel = {
                x,
                y,
                color: currentColorChoice
            };

            const pixelRef = doc(db, "pixels", `${pixel.x}-${pixel.y}`);
            setDoc(pixelRef, pixel, { merge: true });
        }

        // Обработчик кликов на канвас и курсор
        cursor.addEventListener('click', addPixelIntoGame);
        game.addEventListener('click', addPixelIntoGame);

        // Функция для рисования сетки
        function drawGrids(ctx, width, height, cellWidth, cellHeight) {
            ctx.beginPath();
            ctx.strokeStyle = "#ccc";

            for (let i = 0; i < width / cellWidth; i++) {
                ctx.moveTo(i * cellWidth, 0);
                ctx.lineTo(i * cellWidth, height);
            }

            for (let i = 0; i < height / cellHeight; i++) {
                ctx.moveTo(0, i * cellHeight);
                ctx.lineTo(width, i * cellHeight);
            }
            ctx.stroke();
        }

        drawGrids(gridCtx, game.width, game.height, gridCellSize, gridCellSize);

        // Слежение за движением мыши
        game.addEventListener('mousemove', function(event) {
            const cursorLeft = event.clientX - (cursor.offsetWidth / 2);
            const cursorTop = event.clientY - (cursor.offsetHeight / 2);

            cursor.style.left = Math.floor(cursorLeft / gridCellSize) * gridCellSize + "px";
            cursor.style.top = Math.floor(cursorTop / gridCellSize) * gridCellSize + "px";
        });

        // Слушаем изменения в коллекции и отрисовываем пиксели
        onSnapshot(collection(db, "pixels"), function(querySnapshot) {
            querySnapshot.docChanges().forEach(function(change) {
                const { x, y, color } = change.doc.data();
                createPixel(x, y, color);
            });
        });
    </script>

    <script src="script.js"></script>

</body>
</html>
